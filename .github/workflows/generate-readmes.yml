name: Generate Smart READMEs

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["Update File Test"]
    types: [completed]

permissions:
  contents: write

jobs:
  generate-smart-readmes:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          pip install --no-cache-dir pyyaml

      - name: Generate READMEs (auto + meta)
        run: |
          python3 << 'EOF'
          import os
          import yaml
          import urllib.parse

          REPO_URL = "https://github.com/${{ github.repository }}/blob/main"
          IGNORE_DIRS = {".git", ".github"}
          IGNORE_FILES = {"README.md", "LICENSE", "release_body.md"}

          GLOBAL_RULES_PATH = ".github/readme-rules.yaml"

          # ------------------ å·¥å…·å‡½æ•° ------------------
          def load_yaml(path):
              try:
                  with open(path, encoding="utf-8") as f:
                      return yaml.safe_load(f) or {}
              except Exception:
                  return {}

          def file_size(path):
              try:
                  s = os.path.getsize(path)
                  return f"{s} B" if s < 1024 else f"{s/1024:.1f} KB"
              except Exception:
                  return "Unknown"

          def classify_filename(name, rules):
              tags = []
              for r in rules.get("file_rules", []):
                  if r.get("match") and r["match"].lower() in name.lower():
                      tags.append(r.get("tag"))
              return " / ".join(tags) if tags else "é€šç”¨"

          def beautify_title(name):
              return name.replace("_", " ").replace("-", " ").title()

          # ------------------ åŠ è½½å…¨å±€è§„åˆ™ ------------------
          GLOBAL_RULES = load_yaml(GLOBAL_RULES_PATH)

          # ------------------ ä¸»é€»è¾‘ ------------------
          for root, dirs, files in os.walk("."):
              dirs[:] = [d for d in dirs if d not in IGNORE_DIRS]

              if root == ".":
                  continue

              real_files = [
                  f for f in files
                  if not f.startswith(".") and f not in IGNORE_FILES
              ]
              yaml_files = [
                  f for f in real_files
                  if f.lower().endswith((".yml", ".yaml"))
              ]

              if not real_files:
                  continue

              rel = os.path.relpath(root, ".")
              meta_path = os.path.join(root, "._meta.yaml")
              meta = load_yaml(meta_path) if os.path.exists(meta_path) else {}

              # ---------- å†³å®šæ¨¡å¼ ----------
              if meta:
                  mode = meta.get("type", "single")
              else:
                  mode = "single-auto" if len(yaml_files) == 1 else "collection-auto"

              title = meta.get("title") or beautify_title(os.path.basename(root))
              alias = GLOBAL_RULES.get("name_alias", {}).get(os.path.basename(root))
              if alias:
                  title = alias

              lines = []
              lines.append(f"# {title}\n")

              # ---------- é¡¹ç›®é“¾æ¥ ----------
              if meta.get("project_url"):
                  lines.append(f"> é¡¹ç›®åœ°å€ï¼š{meta['project_url']}")
              if meta.get("telegram"):
                  lines.append(f"> Telegramï¼š{meta['telegram']}")
              if meta.get("author"):
                  lines.append(f"> ä½œè€…ï¼š{meta['author']}")
              if meta:
                  lines.append("")

              # ---------- å•æ–‡ä»¶ ----------
              if mode.startswith("single"):
                  target = yaml_files[0] if yaml_files else None
                  if target:
                      url = f"{REPO_URL}/{urllib.parse.quote(rel)}/{urllib.parse.quote(target)}"
                      lines.append("## ğŸ“„ é…ç½®è¯´æ˜\n")
                      lines.append(f"- **æ–‡ä»¶**ï¼š`{target}`")
                      lines.append(f"- **å¤§å°**ï¼š{file_size(os.path.join(root, target))}")
                      lines.append(f"- **é“¾æ¥**ï¼š[æŸ¥çœ‹æºç ]({url})")

                      if meta.get("files", {}).get(target, {}).get("description"):
                          lines.append(f"\n{meta['files'][target]['description']}")

              # ---------- å¤šæ–‡ä»¶ ----------
              else:
                  lines.append("## ğŸ“¦ é…ç½®æ–‡ä»¶åˆ—è¡¨\n")
                  lines.append("| æ–‡ä»¶å | å¤§å° | å®šä½ | é“¾æ¥ |")
                  lines.append("| :--- | :--- | :--- | :--- |")

                  for f in sorted(yaml_files):
                      tag = classify_filename(f, GLOBAL_RULES)
                      url = f"{REPO_URL}/{urllib.parse.quote(rel)}/{urllib.parse.quote(f)}"
                      lines.append(
                          f"| `{f}` | {file_size(os.path.join(root, f))} | {tag} | [æŸ¥çœ‹]({url}) |"
                      )

              # ---------- æ–‡ä»¶å…œåº• ----------
              others = [f for f in real_files if f not in yaml_files]
              if others:
                  lines.append("\n## ğŸ“ å…¶ä»–æ–‡ä»¶\n")
                  lines.append("| æ–‡ä»¶ | å¤§å° | é“¾æ¥ |")
                  lines.append("| :--- | :--- | :--- |")
                  for f in others:
                      url = f"{REPO_URL}/{urllib.parse.quote(rel)}/{urllib.parse.quote(f)}"
                      lines.append(
                          f"| `{f}` | {file_size(os.path.join(root, f))} | [æŸ¥çœ‹]({url}) |"
                      )

              # ---------- License ----------
              if meta.get("license"):
                  lines.append("\n## ğŸ“„ License\n")
                  lines.append(meta["license"])

              with open(os.path.join(root, "README.md"), "w", encoding="utf-8") as f:
                  f.write("\n".join(lines))

              print(f"Generated README: {rel}")

          EOF

      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add **/README.md
          git commit -m "Docs: auto-generate smart READMEs" || echo "No changes to commit"
          git push origin HEAD:${{ github.ref_name }}
